<!DOCTYPE html>
<html class="foo">
<head>
  <meta charset="utf-8">
  <title>Mobify.js Anchor Link Tests</title>
  <link rel="stylesheet" href="/tests/resources/qunit-1.10.0.css">
  <script src="/tests/resources/qunit-1.10.0.js"></script>
  <script src="/tests/resources/jquery-1.7.1.js"></script>

  <meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>

<div id="qunit"></div>

<div id="qunit-fixture">
</div>

<script>
    // http://api.qunitjs.com/QUnit.config/
    QUnit.config.autostart = false;
    QUnit.config.testTimeout = 30 * 1000;

    QUnit.start();

    var skip = function() {
        return false;
    }

    var testSetup = function(src, ready, beforeLoad) {
        console.log("Test Setup");

        var opts = {
            id: "tag-test.html",
            src: src
        };
        var $iframe = $("<iframe>", opts);
        var el = $iframe[0];

        // Clear cookies
        document.cookie = 'mobify=0' +
            '; expires=' + (new Date(Date.now() - 1000)).toGMTString() +
            '; path=/';

        document.cookie = 'mobify-mode=' +
            '; expires=' + (new Date(Date.now() - 1000)).toGMTString() +
            '; path=/';

        document.cookie = 'mobify-preview=' +
            '; expires=' + (new Date(Date.now() - 1000)).toGMTString() +
            '; path=/';

        window.addEventListener("message", function onMessage(event) {
            if (event.source != el.contentWindow) return;
            window.removeEventListener("message", onMessage, false);
            var win = el.contentWindow;
            var doc = el.contentWindow.document;

            setTimeout(function() {
                if (skip()) {
                    ok(true, "Test harness does not work. Must be tested manually.");
                    return start();
                }

                // Call ready so we can fire assertions
                ready(win, doc, event);
            }, 100);
        }, false);

        if (beforeLoad) { beforeLoad(el) };

        $("#qunit-fixture").append($iframe);

        console.log("Attached");
    };

    asyncTest("Mobify.points exists", function() {
        testSetup("/tests/fixtures/tag/tag.html", function(win, doc, event) {
            equal(win.Mobify.points.length, 1, "Mobify.points is an array");
            equal(typeof win.Mobify.points[0], "number", "Mobify.point[0] is a number");

            start();
        });
    });

    asyncTest("Mobify.userAgent exists", function() {
        testSetup("/tests/fixtures/tag/tag.html", function(win, doc, event) {
            equal(win.Mobify.userAgent, window.navigator.userAgent, "Mobify.userAgent exists");

            start();
        });
    });

    asyncTest("There is a plaintext tag", function() {
        testSetup("/tests/fixtures/tag/tag.html", function(win, doc, event) {
            equal(event.data, "loaded", "Expected event was received.");
            ok(doc.getElementsByTagName("plaintext")[0], "Plaintext element exists");
            equal(win.mobifyjsFileName, "/tests/fixtures/tag/mobify.js", "Correct file was loaded.");
            equal(doc.getElementById("content"), null, "#content should not exist");

            start();
        });
    });



    asyncTest("Unmobifies Correctly", function() {
        testSetup("/tests/fixtures/tag/failed-load-tag.html", function(win, doc, event) {
            equal(event.data, "error", "Expected error was received.")
            equal(doc.getElementsByTagName("plaintext").length, 0, "Plaintext element does not exist");
            notEqual(doc.getElementById("content"), null, "#content should exist");

            start();
        });
    });

    asyncTest("Loads Desktop Correctly", function() {
        testSetup("/tests/fixtures/tag/desktop.html", function(win, doc, event) {
            equal(event.data, "desktop", "Expected desktop event was received.")
            equal(doc.getElementsByTagName("plaintext").length, 0, "Plaintext element does not exist");
            equal(win.mobifyjsFileName, "/tests/fixtures/tag/desktop.js", "Correct file was loaded.");
            notEqual(doc.getElementById("content"), null, "#content should exist");

            start();
        });
    });

    asyncTest("Loads mobile correctly when forced via Mode cookie", function() {
        testSetup("/tests/fixtures/tag/desktop.html", function(win, doc, event) {
            equal(event.data, "loaded", "Expected loaded event was received.")
            equal(doc.getElementsByTagName("plaintext").length, 1, "Plaintext element does exist");
            equal(win.mobifyjsFileName, "/tests/fixtures/tag/mobify.js", "Correct file was loaded.");
            equal(doc.getElementById("content"), null, "#content should not exist");

            start();
        }, function (el) {
            document.cookie = "mobify-mode=mobile; path=/";
        });
    });

    asyncTest("Loads mobile correctly via correct userAgent", function() {
        testSetup("/tests/fixtures/tag/useragent.html", function(win, doc, event) {
            equal(event.data, "loaded", "Expected loaded event was received.")
            equal(doc.getElementsByTagName("plaintext").length, 1, "Plaintext element does exist");
            equal(win.mobifyjsFileName, "/tests/fixtures/tag/mobify.js", "Correct file was loaded.");
            equal(doc.getElementById("content"), null, "#content should not exist");

            start();
        }, function (el) {
            document.cookie = "mobify-mode=mobile; path=/";
        });
    });

    asyncTest("Fires preload callback", function() {
        testSetup("/tests/fixtures/tag/preload.html", function(win, doc, event) {
            equal(win.preloadFired, true, "Preload fired.");

            start();
        }, function (el) {
            document.cookie = "mobify-mode=mobile; path=/";
        });
    });

    asyncTest("Fires postload callback", function() {
        testSetup("/tests/fixtures/tag/postload.html", function(win, doc, event) {
            equal(win.postloadFired, true, "Postload fired.");

            start();
        }, function (el) {
            document.cookie = "mobify-mode=mobile; path=/";
        });
    });

    asyncTest("isPreview detects `mobify-preview` in hash.", function() {
        testSetup("/tests/fixtures/tag/no-run.html#mobify-preview&foo", function(win, doc, event) {
            equal(win.Mobify.isPreview(), true, "Preview condition detected.");

            start();
        });
    });

    asyncTest("isPreview detects `mobify-preview` in cookie.", function() {
        testSetup("/tests/fixtures/tag/no-run.html", function(win, doc, event) {
            equal(win.Mobify.isPreview(), true, "Preview condition detected.");

            start();
        }, function (el) {
            document.cookie = "mobify-preview=true; path=/";
        });
    });

    asyncTest("isPreview does not trigger without cookie or hash.", function() {
        testSetup("/tests/fixtures/tag/no-run.html", function(win, doc, event) {
            equal(win.Mobify.isPreview(), false, "Preview condition not detected.");

            start();
        });
    });

    asyncTest("Loads preview correctly", function() {
        testSetup("/tests/fixtures/tag/preview.html#mobify-preview", function(win, doc, event) {
            equal(win.Mobify.isPreview(), true, "Preview condition not detected.");

            equal(event.data, "preview", "Expected preview event was received.")
            equal(doc.getElementsByTagName("plaintext").length, 1, "Plaintext element does exist");
            equal(doc.getElementById("content"), null, "#content should not exist");

            start();
        });
    });     

</script>
</body>
</html>
