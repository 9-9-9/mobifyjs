<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="qunit/qunit.css">
    <script src="qunit/qunit.js"></script>  
    <!-- <script src="qunit/junit.js"></script> -->
</head>
<body>
    <!-- 
    USAGE
    1. run the test server: node tests/server.js
    2. localtunnel 1337 (so combo can see the scripts)
    3. navigate to the localtunnel url
    -->


    <!-- QUNIT -->

    <h1 id="qunit-header">QUnit Test Suite</h1>  
    <h2 id="qunit-banner"></h2>  
    <div id="qunit-testrunner-toolbar"></div>  
    <h2 id="qunit-userAgent"></h2>  
    <ol id="qunit-tests"></ol>  

    <!-- FIXTURES -->

    <script src="../vendor/zepto.js"></script>
    <script>
        Mobify = window.Mobify || {};
        Mobify.$ = $
    </script>
    <script src="../api/combo-caching.js"></script>
    <script src="../api/combo-client.js"></script>

    <iframe src="fixtures/combo/combo-iframe.html" id="combo-iframe"></iframe>

    <script>
// patient test runner
Mobify.$('iframe').on('load', function() {
    WAITING--;
    if (READY && !WAITING) runTests();
});
    
// iframe setup.
READY = false
WAITING = Mobify.$('iframe').length
    </script>

    <!-- Expected state of the document after the flood. -->
    <textarea id="test-combineScripts">
        <html>
            <head>
                <script>Mobify = window.Mobify || {};</script>
                <script src="../api/combo-caching.js"></script>
            </head>
            <body>
                {scriptsHtml}
            </body>
        </html>
    </textarea>
    <!-- TESTS -->

    <script>
function runTests() {

//DEBUG
console.log("Running tests!")

var getIframeDocument = function(selector) {
        var iframe = $(selector)[0];
        return (iframe.contentDocument || iframe.contentWindow.document);
    }
  , $ = Mobify.$;


module('Mobify.combo')

asyncTest('Mobify.combo.combineScripts', 1, function() {

    //DEBUG
    console.log('asyncTest started');

    var doc = getIframeDocument('#combo-iframe')
      , $got = $('#test-combineScripts', doc).combineScripts().removeAttr('type')
      , scriptsHtml = $.map($got, function(el) {
            return el.outerHTML
        }).join("\n")
      , html = $('#test-combineScripts').text().replace('{scriptsHtml}', scriptsHtml)

      console.log($got);

    doc.open();
    doc.write(html);
    doc.close();

    Mobify.combo.clearCache();

    equal(doc.defaultView.combo.length, 3);
    console.log('woo');
    start();

});

} //end runTests

// Impatient test runner, the setting of READY must remain at the end
READY = true;
if (!WAITING) runTests();

    </script>
<body>
</html>