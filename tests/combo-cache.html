<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="qunit/qunit.css">
    <script src="qunit/qunit.js"></script>  
    <!-- <script src="qunit/junit.js"></script> -->
</head>
<body>
    <!-- 
    USAGE
    1. run the test server: node tests/server.js
    2. localtunnel 1337 (so combo can see the scripts)
    3. navigate to the localtunnel url
    -->


    <!-- QUNIT -->
    <h1 id="qunit-header">QUnit Test Suite</h1>  
    <h2 id="qunit-banner"></h2>  
    <div id="qunit-testrunner-toolbar"></div>  
    <h2 id="qunit-userAgent"></h2>  
    <ol id="qunit-tests"></ol>  

    <!-- FIXTURES -->
    <script src="../vendor/zepto.js"></script>
    <script>
        Mobify = window.Mobify || {};
        Mobify.$ = $
    </script>

    <script src="../api/combo-caching.js"></script>

    <!-- TESTS rehydrateCache-->
    <script>
    module('Mobify.combo rehydrate');

    test('rehydrate cache', 2, function() {
        Mobify.combo.clearCache();

        // Let's build a dehydrated cache by hand and test rehydration
        testMessage = "Hello, from the dehydrated cache."

        test_cache_contents = {
            'key1': {
                'msg': testMessage
            },
            'key2': {
                'msg': testMessage
            }
        }

        localStorage[Mobify.httpCaching.lsKey] = JSON.stringify(test_cache_contents);

        Mobify.combo.rehydrateCache();

        equal(testMessage, Mobify.combo.resources['key1']['msg'], "key1 rehydrated");
        equal(testMessage, Mobify.combo.resources['key2']['msg'], "key2 rehydrated");
    });

    module('Mobify.combo dehydrate')

    asyncTest('dehydrates successfully, no evictions', 1, function() {
        Mobify.combo.clearCache();

        Mobify.combo.resources['foo'] = 'bar';
        var resourcesJSON = JSON.stringify(Mobify.combo.resources);

        Mobify.combo.dehydrateCache();
        // Check asynchronosuly, since dehydrate won't store until after the next tick
        setTimeout(function() {
            equal(localStorage[Mobify.httpCaching.lsKey], resourcesJSON, "dehydrated to localStorage");
            start();
        }, 0);
    });

    asyncTest('evicts all', 1, function() {
        Mobify.combo.clearCache();

        // This will produce an 8-million+ character string we can take substrings of the build things that should be problematic for localStorage
        var longString = Array(5000000).join('a');
        
        // Set up some mock resources
        Mobify.combo.resources['http://foo.bar/baz.js'] = {
                lastUsed: 2,
                data: longString
        }
        Mobify.combo.resources['http://bar.baz/foo'] = {
            lastUsed: 1
        }

        Mobify.combo.dehydrateCache();

        //The big resource is most recently used, so we expect that the empty object's JSON representation should have been stored
        setTimeout( function(){
            equal(localStorage[Mobify.httpCaching.lsKey], '{}', 'nothing survived eviction in dehydration');
            start();
        }, 1500);
    });

    asyncTest('evicts one', 1, function() {
        Mobify.combo.clearCache();

        var longString = Array(5000000).join('a');

        Mobify.combo.resources['http://foo.bar/baz.js'] = {
                lastUsed: 1,
                data: longString
        }
        Mobify.combo.resources['http://bar.baz/foo'] = {
            lastUsed: 2
        }

        var survives = {
            'http://bar.baz/foo': {
                lastUsed: 2
            }
        }

        var survivesJSON = JSON.stringify(survives);

        Mobify.combo.dehydrateCache();

        // The big resource is least recently used, so it should be evicted and the smaller resource should be left
        setTimeout( function() {
            equal(localStorage[Mobify.httpCaching.lsKey], survivesJSON, 'smaller, more recently used item survived cache dehydration');
            start();
        }, 1500);
    });

    module('http caching staleness');

    test('evicts stale', 6, function() {
        Mobify.combo.clearCache();

        // Time offsets in seconds
        var TWO_WEEKS = 14 * 24 * 60 * 60
          , TEN_MINUTES = 600
          // UTC dates
          , UTC_TWO_WEEKS_FROM_NOW = (new Date(Date.now() + (TWO_WEEKS * 1000))).toUTCString()
          , UTC_TWO_WEEKS_AGO = (new Date(Date.now() - (TWO_WEEKS * 1000))).toUTCString()
          , UTC_NOW = (new Date()).toUTCString()

        // stale becuase of past expires header
        var stale = Mobify.combo.resources['http://foo.bar/stale'] = {
            'headers': {
                'expires': UTC_TWO_WEEKS_AGO
            }
        }
        // stale because of date and cache-control headers
        var stale2 = Mobify.combo.resources['http://foo.bar/stale2'] = {
            'headers': {
                'date': UTC_TWO_WEEKS_AGO
                , 'cache-control': 'public,max-age=' + TEN_MINUTES
            }
        }

        // fresh because of future expires header
        var fresh = Mobify.combo.resources['http://foo.bar/fresh'] = {
            'headers': {
                'expires': UTC_TWO_WEEKS_FROM_NOW
            }
        }
        // fresh because of date and cache-control headers
        var fresh2 = Mobify.combo.resources['http://foo.bar/fresh2'] = {
            'headers': {
                'date': UTC_NOW
                , 'cache-control': 'public,max-age=' + TEN_MINUTES
            }
        }

        // Check that staleness evaluation works for stale things
        equal(true, Mobify.httpCaching.isStale(stale), 'stale via expires resource reads as stale');
        equal(true, Mobify.httpCaching.isStale(stale2), 'stale via date and cahe-control resource reads as stale');
        // And for fresh things
        equal(false, Mobify.httpCaching.isStale(fresh), 'fresh via expires resource reads as not stale');
        equal(false, Mobify.httpCaching.isStale(fresh2), 'fresh via date and cache-control resource reads as not stale');

        
        // Now let's make the stale resource get evicted
        Mobify.httpCaching.evictStale();
        equal(undefined, Mobify.combo.resources['http://foo.bar/stale'], 'stale resource was evicted');
        equal(fresh, Mobify.combo.resources['http://foo.bar/fresh'], 'fresh resource was not evicted');

    });
    </script>

</body>
</html>