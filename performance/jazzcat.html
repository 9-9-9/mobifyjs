<html>
<head>
<title>Performance tests for Jazzcat</title>
<style>
.hide {
    display: none;
}
</style>
</head>
<body>

<h1>Performance test for Jazzcat</h1>
<form>
    <p>Range: <input type="text" name="range" value="5"></p>
    <p>Step Size: <input type="text" name="stepsize" value="5"></p>
    <p>Runs per script: <input type="text" name="runs" value="5"></p>
    <input type="submit" value="Run Test">
</form>

<img src="/mobifyjs/performance/resources/images/ajax-loader.gif" class="hide">

<div id="chartContainer" style="height: 300px; width: 100%;"></div>

<script src="/mobifyjs/performance/resources/jquery.js"></script>
<script>

var createIframe = function(url, callback) {
    var cb = function(event){
        var diff = event.data;
        window.removeEventListener("message", cb);
        callback && callback(diff);
    };

    window.addEventListener("message", cb);

    // must re-create the iframe (can't use iframe.contentWindow.location.reload() because
    // firefox reload won't work after doc.write)
    var removeIframe = document.getElementsByTagName("iframe");
    if (removeIframe.length > 0) {
        removeIframe[0].parentNode.removeChild(removeIframe[0]);
    }
    var iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.setAttribute("style", "display: none;");
    document.getElementsByTagName("body")[0].appendChild(iframe);

};

var create2dArray = function(length, runs) {
    var array = new Array(length);
    for (var i=0; i<length; i++) {
        array[i] = new Array(runs);
    }
    return array;
}

var run = function(finishedCallback){
    if (i===scriptRange.length) {
        finishedCallback();
        return;
    }

    var mobifyUrl = "/performance/jazzcat/runner/" + scriptRange[i] + "#mobify=1";
    var nativeUrl = "/performance/jazzcat/runner/" + scriptRange[i] + "#mobify=0";

    var j = 0;

    var runTestLoop = function(callback) {
        if (j===runsPerTest) {
            callback();
            return;
        }
        createIframe(mobifyUrl, function(diff){
            mobifyResults[i][j] = diff;
            createIframe(nativeUrl, function(diff){
                nativeResults[i][j] = diff;
                j++;
                runTestLoop(callback);
            })
        });
    };

    runTestLoop(function() {
        i++;
        run(finishedCallback);
    })
};

var avg = function(arr) {
    var sum = arr.reduce(function(prev, curr){
        return prev + curr;
    });
    return sum/arr.length;
}

$("form").submit(function(e){
    e.preventDefault();
    $("img").removeClass("hide");
    var form = this;

    // TODO: being lazy, do this without globals
    window.runsPerTest = parseInt(form.runs.value);
    window.scriptRange = new Array(parseInt(form.range.value));
    window.stepSize = parseInt(form.stepsize.value);

    // always start with 1 script for first test
    scriptRange[0] = 1;
    for (var i=1; i<scriptRange.length; i++) {
        scriptRange[i] = i * stepSize;
    }

    var scriptsMsg = "Scripts Used: " + scriptRange.join(", ");
    console.log(scriptsMsg);
    $("body").append($("<p>" + scriptsMsg + "</p>"));

    window.mobifyResults = create2dArray(scriptRange.length, runsPerTest);
    window.nativeResults = create2dArray(scriptRange.length, runsPerTest);
    window.i = 0;

    run(function(){
        var averagedMobifyResults = mobifyResults.map(function(testSet){
            return avg(testSet).toFixed(1);
        });
        var averagedNativeResults = nativeResults.map(function(testSet){
            return avg(testSet).toFixed(1);
        });
        var mobifyResultsMsg = "Mobify results: " + averagedMobifyResults.join(", ");
        var nativeResultsMsg = "Native results: " + averagedNativeResults.join(", ");
        console.log(mobifyResultsMsg);
        console.log(nativeResultsMsg);
        $("body").append($("<p>" + mobifyResultsMsg + "</p>"));
        $("body").append($("<p>" + nativeResultsMsg + "</p>"));
        $("img").addClass("hide");

        renderChart(scriptRange, averagedMobifyResults, averagedNativeResults);

    });
})

var createPoints = function(x, y) {
    var points = [];
    for (var i=0; i<x.length; i++) {
        // TODO: only dividing by 10 because canvasjs
        // seems to blow up when #'s are too big. Figure out why!
        points.push({x: x[i], y: y[i]/10});
    }
    console.log(points);
    return points;
}

var renderChart = function (scripts, mobifyData, nativeData) {

    var chart = new CanvasJS.Chart("chartContainer",
            {
                zoomEnabled: true,
                panEnabled: true,
                axisY:{
                    includeZero: false
                },               
                theme: "theme2",
                legend:{
                    verticalAlign: "center",
                    horizontalAlign: "right",
                },
                data: [
                {        
                    type: "line",
                    showInLegend: true,
                    name: "Jazzcat",
                    markerType: "square",
                    color: "LightCoral",
                    dataPoints: createPoints(scripts, mobifyData)
                },
                {        
                    type: "line",
                    showInLegend: true,
                    name: "Native",
                    color: "LightSeaGreen",
                    dataPoints: createPoints(scripts, nativeData)
                },

                
                ]
            });

    chart.render();

}
</script>
<script type="text/javascript" src="/mobifyjs/performance/resources/canvasjs.min.js"></script>

</body>
</html>